# Mattermost Local Development - Docker Compose
# Runs separate frontend and backend containers for testing

services:
  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: mm-postgres
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: mostest
      POSTGRES_DB: mattermost
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Mattermost Backend (Go Server)
  # ==========================================================================
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: mm-backend
    environment:
      # Database (same as staging, different connection string for local)
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: "postgres://mmuser:mostest@postgres:5432/mattermost?sslmode=disable&connect_timeout=10"

      # Service settings (matching staging)
      MM_SERVICESETTINGS_SITEURL: "http://localhost:8080"
      MM_SERVICESETTINGS_LISTENADDRESS: ":8065"
      # Enable webserver mode to serve plugin static files
      MM_SERVICESETTINGS_WEBSERVERMODE: "gzip"
      MM_SERVICESETTINGS_ENABLELOCALMODE: "true"
      MM_SERVICESETTINGS_ENABLEOPENSERVER: "false"
      MM_SERVICESETTINGS_EXPERIMENTALGROUPUNREADCHANNELS: "default_on"
      MM_SERVICESETTINGS_ENABLEAPIDOCUMENTATION: "true"

      # CORS configuration (matching staging)
      MM_SERVICESETTINGS_ALLOWCORSFROM: "*"
      MM_SERVICESETTINGS_CORSALLOWCREDENTIALS: "true"
      MM_SERVICESETTINGS_CORSEXPOSEDHEADERS: "X-Request-Id"

      # File storage (local for dev, staging uses GCS)
      MM_FILESETTINGS_DRIVERNAME: local
      MM_FILESETTINGS_DIRECTORY: /mattermost/data/files
      MM_FILESETTINGS_MAXFILESIZE: "104857600"

      # Logging (matching staging)
      MM_LOGSETTINGS_CONSOLELEVEL: "INFO"
      MM_LOGSETTINGS_ENABLEFILE: "false"

      # Disable telemetry for local dev
      MM_LOGSETTINGS_ENABLEDIAGNOSTICS: "false"

      # Allow backend to call bot service (internal docker hostname)
      MM_SERVICESETTINGS_ALLOWEDUNTRUSTEDINTERNALCONNECTIONS: "bot"

      # Plugin settings - Enable Calls
      MM_PLUGINSETTINGS_ENABLE: "true"
      MM_PLUGINSETTINGS_ENABLEUPLOADS: "true"
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: "true"
      # Calls plugin config - enable by default for all users
      MM_PLUGINSETTINGS_PLUGINS: '{"com.mattermost.calls":{"defaultenabled":true,"allowscreensharing":true}}'
    ports:
      - "8065:8065"
      - "8067:8067"
    volumes:
      - backend_data:/mattermost/data
      - backend_logs:/mattermost/logs
      - backend_plugins:/mattermost/plugins
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/mattermost/bin/mmctl", "system", "status", "--local"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  # ==========================================================================
  # Mattermost Frontend (Nginx)
  # ==========================================================================
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: mm-frontend
    environment:
      # Backend service name in docker-compose
      BACKEND_HOST: backend
    ports:
      - "8080:8080"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  # ==========================================================================
  # MongoDB (for Bot Service)
  # ==========================================================================
  mongodb:
    image: mongo:7
    container_name: mm-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Bot Service (Attendance + Budget)
  # ==========================================================================
  bot:
    build:
      context: ../bot
      dockerfile: Dockerfile
    container_name: mm-bot
    environment:
      PORT: "3000"
      ENV: development
      BOT_URL: "http://bot:3000"
      MONGODB_URI: "mongodb://mongodb:27017"
      MONGODB_DATABASE: oktel
      MATTERMOST_URL: "http://backend:8065"
      # Tokens will be set after creating bot accounts in Mattermost
      ATTENDANCE_BOT_TOKEN: "${ATTENDANCE_BOT_TOKEN:-}"
      BUDGET_BOT_TOKEN: "${BUDGET_BOT_TOKEN:-}"
    ports:
      - "3000:3000"
    depends_on:
      mongodb:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  postgres_data:
  backend_data:
  backend_logs:
  backend_plugins:
  mongo_data:
